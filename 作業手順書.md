# ミニCRM（案件〜請求）MVP 作業手順書

本ドキュメントは、`ミニcrm（案件〜請求）mvp仕様書_v_0.md` を**そのまま採用**し、既存のページ/コンポーネントのスタイルを踏襲しながら、MVP（P0）と受け入れ条件（AC）を満たすための実装手順を定義します。

## 0. ゴール（Definition of Done）

以下を満たしたら「作り切り」とします。

- 仕様書の **P0（MVPリリース条件）** をすべて満たす（`ミニcrm（案件〜請求）mvp仕様書_v_0.md` の「10. バックログ（P0 / P1）」参照）
- 仕様書の **AC-01〜AC-10** を、デモシナリオ（操作手順）で再現できる（同「11. 受け入れ条件」参照）
- 公開デモ版の永続化要件は **ローカルSEED → sessionStorage** で満たす（同「8.2 公開デモ版」参照）
- `npm run lint` が通る

## 1. 前提（今回の決定事項）

- データ永続化はまず **ローカルSEED → `sessionStorage`**（Supabase seed は後回し）
- **Invoice 一覧ページを作成**する（仕様書「6.3 請求（一覧）」を実装対象に含める）
- 既存の `data-table` の見た目/体験は維持し、**列の追加/削除を中心**に実装する
  - ただし、仕様書の要件（Alerts/インライン編集/クイック操作/バリデーション誘導/同期）を満たすための**最小限の拡張**は許容
- Deal の詳細は「ページ」ではなく **Inspector（右ドロワー）** を主導線とするため、`src/app/deals/[id]/` は削除する

## 2. 実装順序（依存が少ない順）

### Step A：不要ルート削除（詳細ページ）

- [ ] `src/app/deals/[id]/page.tsx` を削除
- [ ] 参照が残っていないことを確認（`/deals/:id` へのリンク等）

成果物：
- ルート設計が「一覧 + Inspector」に一本化される

### Step B：デモ用データ基盤（SEED → sessionStorage）

- [ ] 仕様書「13.2 デモ用シードデータ（8件）」に合わせたローカルSEEDを用意
- [ ] ロード優先順位を実装
  - `sessionStorage` に state があればロード
  - なければローカルSEEDから初期化
- [ ] 保存タイミングを実装（更新のたびに `sessionStorage` へ保存）
- [ ] 「デモをリセット」（`sessionStorage` クリア → SEED再ロード）を用意

成果物：
- DBなしでもデモの編集が維持される（同タブ内）

### Step C：日付/営業日ユーティリティ（アラート・期日計算の基盤）

- [ ] 仕様書「8.0 営業日（Business Day）の扱い」に沿って、営業日計算（MVPは土日除外）を実装
- [ ] `effective_due_date`（週末補正）を実装
- [ ] 「3営業日以内」「1日超過」の判定を実装
- [ ] `invoice_date` → `invoice_due_date=翌月末` の初期値計算を実装

成果物：
- Alerts判定とクイック操作の自動補完を共通関数で再利用できる

### Step D：ViewModel（Deal Object）を確定

- [ ] 仕様書「6.7.2 Deal Object」に沿って、画面で扱う Deal ViewModel を定義
- [ ] `invoice_summary`、`amount_outstanding`、`is_due_soon`、`is_overdue` 等の算出を実装
- [ ] UI側が **このViewModelのみ**を参照する構造に寄せる

成果物：
- Deals / Inspector / Dashboard / Invoices が同じデータ形で動く

### Step E：Deals 一覧（DataTable列の入れ替え + フィルタ）

- [ ] 仕様書「6.7.1 Deal DataTable」の **固定カラム**を実装
  - Alerts / 次アクション / 請求予定月 / 請求状態 / 入金期日 / 未回収額 など
- [ ] 検索・フィルタ（ステータス/担当/請求予定月/取引先/案件名）を実装
- [ ] 「案件名クリックで Inspector を開く」を維持し、行クリックは選択のみ（誤操作防止）

成果物：
- “一覧で自己解決” の運用が回る

### Step F：Alerts（表示・+n・Tooltip・QuickFilter優先表示）

- [ ] 仕様書「7.3 UIアラート」の4種を判定できる
- [ ] 優先順位（遅延 > 期日接近 > 当月未請求 > 次アクション期限切れ）に沿って表示
- [ ] 複数成立時は `+n` を併記
- [ ] Tooltip に理由テンプレで全件を表示
- [ ] Quick Filter 適用時は「フィルタ対象のラベル」を優先表示

成果物：
- AC-02 を満たす

### Step G：左ナビ Quick Filters ↔ Deals Filter Bar 同期（AC-01）

- [ ] 仕様書「6.2.2 左ナビQuick Filtersとの同期」に沿って同期を実装
- [ ] 実装方針：**URLクエリ（searchParams）を単一ソース**として扱う（推奨）
  - Sidebar 選択 → Deals へ遷移しクエリ更新
  - Deals 側の Filter Bar 更新 → クエリ更新（Sidebar の active も追従）

成果物：
- AC-01 を満たす

### Step H：Deal Inspector（右ドロワー）を作り切る（P0の中心）

- [ ] 仕様書「6.6 Deal Inspector」のフィールド順/編集方式を実装
- [ ] バリデーション：状態遷移（4.3）と必須項目不足時の誘導を実装
- [ ] クイック操作
  - 「請求済みにする」（自動補完→必須チェック→遷移→Activity）
  - 「入金済みにする」（自動補完→必須チェック→遷移→Activity）
- [ ] 成功時の次アクション自動セット（請求：実効期日3営業日前、入金：翌営業日）

成果物：
- AC-03〜AC-07 を満たす

### Step I：Invoices 一覧ページ（請求テーブル）

- [ ] 仕様書「6.3 請求（一覧）」のテーブル/フィルタ（最小）を実装
- [ ] Deals と同じデータ基盤（ViewModel/State）から、Invoice 行を生成
- [ ] 請求状態・入金期日・未回収などを確認できる

成果物：
- P0の「請求フローの可視化」を補完し、デモで説得力が上がる

### Step J：Dashboard（要対応 + KPI + Recent Activity）

- [ ] 仕様書「6.1 ダッシュボード」の構成を実装
  - Alert Summary Cards → クリックで Deals にフィルタ遷移
  - KPI Cards（仮でOK）
  - Recent Activity（直近7日更新のテーブル、案件名クリックでInspector）

成果物：
- P0の Dashboard 要件を満たす

### Step K：最終確認（AC通し・lint）

- [ ] AC-01〜AC-10 を仕様書の Given/When/Then に沿って手動で再現
- [ ] `npm run lint` を実行

## 3. 実装ルール（このリポジトリで守ること）

- UI/スタイルは既存の Yohaku / shadcn/ui を踏襲する（新規デザインの導入は避ける）
- 既存コンポーネントを優先して拡張し、差分を最小化する
- アラート/営業日/期日計算は `src/lib` の純関数に寄せ、ページ間で再利用する

## 4. 実行コマンド（ローカル確認）

- 開発：`npm run dev`
- 静的確認：`npm run lint`
- 本番ビルド確認：`npm run build`

